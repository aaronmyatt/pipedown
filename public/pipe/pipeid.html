<div x-data="pipeActions" x-init="() => {
                const pipe = pipes().find(p => p.id === Number($router.params.pipeid))
                if (pipe) {
                    load(pipe)
                    PD.pdGetPipeOutputs({ server: true, pipe }).then(outputs => {
                        $store.pdPipe.output = outputs.funcOutputs
                    })
                }
            }">
    <template x-if="current">
        <div>
            <pd-pipe></pd-pipe>
        </div>
    </template>
</div>
</template>
<template x-component="pd-pipe" c-data="{ initialInput: {} }">
    <div x-init="() => {
        $store.pdPipe.initialInput = {};
        $store.pdPipe.output = {};
    }" class="d-flex flex-column gap-4">
        <div class="d-flex gap-3">
            <h1>Pipe: <span x-text="current?.name"></span></h1>
            <div class="btn-group">
                <button class="btn btn-primary" type="button" @click="() => pipeForm('open')">Edit</button>
                <button class="btn btn-primary" type="button" @click="() => { deletePipe(); this.$router.push('/') }">
                    Delete
                </button>
                <button class="btn btn-primary" type="button" @click="() => $refs.dependencyform.showModal()">Add
                    Dependency
                </button>
            </div>
        </div>
        <p x-text="current.description"></p>
        <dialog x-ref="pipeform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="() => { savePipe(); pipeForm('close') }">
                <label for="pipename" class="form-label"> Name </label>
                <input class="form-control" type="text" id="pipename" x-model="current.name">
                <label for="pipedescription" class="form-label"> Description </label>
                <input type="text" id="pipedescription" x-model="current.description" class="form-control">
                <div>
                    <label for="pipedefaultinput" class="form-label"> Default Input </label>
                    <input class="form-control" type="text" id="pipedefaultinput"
                        x-text="$el.value = $tojson($store.pipes.current.defaultInput || {})" @input="(event) => {
                        try {
                            $store.pipes.current.defaultInput = JSON.parse(event.target.value)
                            event.target.classList.add('is-valid')
                            event.target.classList.remove('is-invalid')
                        } catch (e) {
                            console.error(e)
                            event.target.classList.add('is-invalid')
                        }
                    }">
                </div>
                <button class="btn btn-primary">Save</button>
            </form>
            <json-viewer :data="$tojson(current)"></json-viewer>
        </dialog>
        <dialog x-ref="dependencyform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="async (e) => {
                const data = Object.fromEntries(new FormData(e.target).entries())
                const newFunction = await $store.functions.newDependencyFunction(data)
                $store.pipes.addFunctionToCurrentPipe(newFunction.id, { start: true })
            }">
                <label for="path" class="form-label"> Path </label>
                <input name="path" class="form-control" type="text" id="path">
                <label for="export" class="form-label"> Export </label>
                <input name="export" type="text" id="export" class="form-control">
                <label for="alias" class="form-label"> Alias </label>
                <input name="alias" type="text" id="alias" class="form-control">
                <label for="deptype" class="form-label"> Type </label>
                <select required name="deptype" type="text" id="deptype" class="form-control">
                    <option value="javascript">.js</option>
                    <option value="css">.css</option>
                    <option value="deno">Deno</option>
                    <!--                    <option value="npm">NPM</option>-->
                </select>
                <button class="btn btn-primary">Save</button>
            </form>
            <json-viewer :data="$tojson(current)"></json-viewer>
        </dialog>
    </div>
    <div class="pdtoolbar sticky-top" x-html="() => {
        return PD.pdPipeToolbar()
          .then(outputs => {
            return outputs.html
          })
    }"></div>
    <template x-if="$store.functions.loaded">
        <pd-pipe-functions>
        </pd-pipe-functions>
    </template>
</template>

<template x-component="pd-pipe-functions">
    <div class="d-flex flex-column gap-1 py-4" x-data="{
        removeFunction(id){
            $store.pipes.removeFunctionFromCurrentPipe(id);
        },
        code: '',
        inputJsonValid: true,
    }">
        <h3 class="h3">Functions</h3>
        (Test) Pipe Input
        <pd-code-editor :class="{
                'border border-2 border-danger': !inputJsonValid,
                'border border-2 border-success': inputJsonValid,
            }" @input="(e) => {
                try{
                    $store.pdPipe.initialInput = JSON.parse(code)
                    inputJsonValid = true
                    
                } catch(e){
                    inputJsonValid = false
                }
            }"></pd-code-editor>
        <p class="text-danger" x-show="!inputJsonValid">JSON invalid</p>
        <div class="d-flex flex-column gap-3" @keydown.escape="() => {
                $el.focus()
                $store.pipes.funcs.forEach(f => f.focus = false);
            }">
            <pd-pipe-input-selector
                @selected="e => { $store.pdPipe.initialInput = $fromjson(e.detail) }"></pd-pipe-input-selector>
            <template x-for="func in $store.pipes.funcs.map(f => { f.focus = false; return f; })" :key="func.id">
                    <div 
                        class="d-flex flex-column gap-1"
                        @focusin="(e) => {
                            $store.pipes.funcs.forEach(f => f.focus = false);
                            func.focus = true;
                        }" 
                        tabindex="1"
                        :class="{
                            'border-start border-success border-5': func.focus,
                            'border border-primary': !func.focus,
                        }"
                    >
                        <pd-function></pd-function>
                        <div x-data="{
                                outputVisible: true,
                            }" 
                            x-init="() => {
                                $watch('$store.pdPipe.output', (value) => {
                                    // console.log(value)
                                    $refs.renderOutput.code = value[func.id]
                                })
                            }"
                            class="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button @click="outputVisible = !outputVisible" class="accordion-button p-1"
                                        type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
                                        aria-expanded="true" aria-controls="collapseOne">
                                        Output
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse"
                                    :class="outputVisible && 'show'" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <pd-code-renderer x-ref="renderOutput"></pd-code-renderer>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </template>
        </div>
    </div>
</template>

<template x-component="pd-pipe-input-selector">
    <div x-data="{
            async pipeInputs(){
                return await PD.pdGetPipeInputs({ server: true, pipe: $store.pipes.current }).then(outputs => {
                    return outputs.pipeInputs
                })
            }
        }">
        <select class="overflow-hidden" @input.stop="() => $dispatch('selected', $el.value)">
            <option> --- Test with an input ---</option>
            <template x-for="(input, index) in pipeInputs">
                <option x-text="$tojson(input)"></option>
            </template>
        </select>
    </div>
    <template x-component="pd-function-form"></template>
</template>
<template x-component="pd-pipe-selector">
    <div x-data="pipeActions">
        <div class="list-group">
            <template x-for="pipe in pipes()">
                <button class="list-group-item list-group-item-action" @click="() => {
                        $dispatch('pipe-selected', pipe.id)
                        $store.pdPipeSelector.selected = pipe.id
                    }">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold" x-text="pipe.name"></div>
                        <span x-text="pipe.description"></span>
                    </div>
                </button>
            </template>
        </div>
    </div>
</template>