<div x-data="pipeActions" x-init="() => {
                const pipe = pipes().find(p => p.id === Number($router.params.pipeid))
                if (pipe) {
                    load(pipe)
                }
            }">
    <template x-if="current">
        <div>
            <div
                class="position-fixed top-50 start-0 translate-middle-y"
                x-html="() => {
                    return PD.sortableFunctionList()
                    .then(outputs => {
                        return outputs.html
                    })
                }">

            </div>
            <pd-pipe></pd-pipe>
        </div>
    </template>
</div>
</template>
<template x-component="pd-pipe" c-data="{ initialInput: {}, output: {}, error: {} }">
    <div x-init="async () => {
        $store.pdPipe.initialInput = {};
        $store.pdPipe.output = {};
        $store.pdPipe.error = {};
        await PD.pdGetPipeOutputs({ server: true, pipe: current }).then(outputs => {
            $store.pdPipe.output = outputs.funcOutputs
        })
    }" class="d-flex flex-column gap-4">
        <div class="d-flex gap-3">
            <div class="btn-group">
                <button class="btn btn-primary" type="button" @click="() => { deletePipe(); this.$router.push('/') }">
                    Delete
                </button>
                <button class="btn btn-primary" type="button" @click="() => $refs.dependencyform.showModal()">Add
                    Dependency
                </button>
            </div>
        </div>
        <div class="row gap-3" @input.stop="() => { savePipe(); }">
            <div class="row">
                <input class="form-control form-control-lg" type="text" id="pipename" x-model="$store.pipes.current.name">
            </div>
            <div class="row">
                <label for="pipedescription" class="form-label col-sm-2 col-form-label"> Description </label>
                <div class="col-sm-10">
                    <input type="text" id="pipedescription" x-model="$store.pipes.current.description" class="form-control">
                </div>
            </div>
            <div class="row">
                <label for="pipedefaultinput" class="form-label col-sm-2 col-form-label"> Default Input </label>
                <div class="col-sm-10">
                    <input class="form-control" type="text" id="pipedefaultinput"
                        x-text="$el.value = $tojson($store.pipes.current.defaultInput || {})" 
                        @input="(event) => {
                            try {
                                $store.pipes.current.defaultInput = JSON.parse(event.target.value)
                                event.target.classList.add('is-valid')
                                event.target.classList.remove('is-invalid')
                            } catch (e) {
                                console.error(e)
                                event.target.classList.add('is-invalid')
                            }
                        }">
                </div>
            </div>
        </div>
        <dialog x-ref="dependencyform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="async (e) => {
                const data = Object.fromEntries(new FormData(e.target).entries())
                const newFunction = await $store.functions.newDependencyFunction(data)
                $store.pipes.addFunctionToCurrentPipe(newFunction.id, { start: true })
            }">
                <label for="path" class="form-label"> Path </label>
                <input name="path" class="form-control" type="text" id="path">
                <label for="export" class="form-label"> Export </label>
                <input name="export" type="text" id="export" class="form-control">
                <label for="alias" class="form-label"> Alias </label>
                <input name="alias" type="text" id="alias" class="form-control">
                <label for="deptype" class="form-label"> Type </label>
                <select required name="deptype" type="text" id="deptype" class="form-control">
                    <option value="javascript">.js</option> 
                    <option value="css">.css</option>
                    <option value="deno">Deno</option>
                    <!--                    <option value="npm">NPM</option>-->
                </select>
                <button class="btn btn-primary">Save</button>
            </form>
        </dialog>
    </div>
    <div class="pdtoolbar sticky-top" x-html="() => {
        return PD.pdPipeToolbar()
          .then(outputs => {
            return outputs.html
          })
    }"></div>
    <template x-if="$store.pdPipe.error?.message">
        <div class="bg-danger-subtle pb-2">
            <h4>Error</h4>
            <pd-code-renderer :code="$tojson($store.pdPipe.error)"></pd-code-renderer>
        </div>
    </template>
    <template x-if="$store.functions.loaded">
        <pd-pipe-functions>
        </pd-pipe-functions>
    </template>
    <template x-if="$store.pdPipe.error?.message">
        <div class="bg-danger-subtle pb-2">
            <h4>Error</h4>
            <pd-code-renderer :code="$tojson($store.pdPipe.error)"></pd-code-renderer>
        </div>
    </template>
</template>

<template x-component="pd-pipe-functions">
    <div class="d-flex flex-column gap-1 py-4" x-data="{
        removeFunction(id){
            $store.pipes.removeFunctionFromCurrentPipe(id);
        },
        code: '',
        inputJsonValid: true,
    }"
    x-init="() => {
        $store.pdPipeFunctions.funcs = []
        const pipe = current;
        $store.pdPipeFunctions.funcs = Alpine.store('functions').allFunctions
            .filter(f => pipe.functions.includes(f.id))
            // sort based on id order in pipe.functions
            .map(f => {
                f.focus = false;
                return f;
            })
            .sort((a, b) => {
                return pipe.functions.indexOf(a.id) - pipe.functions.indexOf(b.id)
            })
    }"
    >
        <h3 class="h3">Functions</h3>
        (Test) Pipe Input
        <pd-code-editor :class="{
                'border border-2 border-danger': !inputJsonValid,
                'border border-2 border-success': inputJsonValid,
            }" @input="(e) => {
                try{
                    $store.pdPipe.initialInput = JSON.parse(code)
                    inputJsonValid = true
                    
                } catch(e){
                    inputJsonValid = false
                }
            }"></pd-code-editor>
        <p class="text-danger" x-show="!inputJsonValid">JSON invalid</p>
        <div class="d-flex flex-column gap-3" @keydown.escape="() => {
                $el.focus()
                $store.pdPipeFunctions.funcs.forEach(f => f.focus = false);
            }">
            <pd-pipe-input-selector
                @selected="e => { $store.pdPipe.initialInput = $fromjson(e.detail) }"></pd-pipe-input-selector>
            <template x-for="func in $store.pdPipeFunctions.funcs" :key="func.id">
                    <div 
                        class="d-flex flex-column gap-1"
                        @focusin="(e) => {
                            $store.pdPipeFunctions.funcs.forEach(f => f.focus = false);
                            func.focus = true;
                        }"
                        x-effect="() => {
                            if(func.focus){
                                $el.scrollIntoView({ behavior: 'smooth', block: 'center' })
                            }
                        }"
                        tabindex="1"
                        :class="{
                            'border-start border-success border-5': func.focus,
                            'border border-primary': !func.focus,
                        }"
                    >
                        <pd-function></pd-function>
                        <div x-data="{
                                outputVisible: $persist(true).as(`pd-pipe-function-${func.id}-output-visible`),
                            }" 
                            x-init="() => {
                                $watch('$store.pdPipe.output', value => {
                                    if(value && func.id in value){
                                        $refs.renderOutput.code = value[func.id];
                                    }
                                })
                            }"
                            class="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button @click="outputVisible = !outputVisible" class="accordion-button p-1"
                                        type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
                                        aria-expanded="true" aria-controls="collapseOne">
                                        Output
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse"
                                    :class="outputVisible && 'show'" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <pd-code-renderer x-ref="renderOutput"></pd-code-renderer>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </template>
        </div>
    </div>
</template>

<template x-component="pd-pipe-input-selector">
    <div x-data="{
            async pipeInputs(){
                return []
                // return await PD.pdGetPipeInputs({ server: true, pipe: $store.pipes.current }).then(outputs => {
                //     return outputs.pipeInputs
                // })
            }
        }">
        <select class="overflow-hidden" @input.stop="() => $dispatch('selected', $el.value)">
            <option> --- Test with an input ---</option>
            <template x-for="(input, index) in pipeInputs">
                <option x-text="$tojson(input)"></option>
            </template>
        </select>
    </div>
    <template x-component="pd-function-form"></template>
</template>
<template x-component="pd-pipe-selector">
    <div x-data="pipeActions">
        <div class="list-group">
            <template x-for="pipe in pipes()">
                <button class="list-group-item list-group-item-action" @click="() => {
                        $dispatch('pipe-selected', pipe.id)
                        $store.pdPipeSelector.selected = pipe.id
                    }">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold" x-text="pipe.name"></div>
                        <span x-text="pipe.description"></span>
                    </div>
                </button>
            </template>
        </div>
    </div>
</template>