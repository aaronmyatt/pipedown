<div x-data="pipeActions"
     x-init="() => {
                const pipe = pipes().find(p => p.id === Number($router.params.pipeid))
                if (pipe) {
                    load(pipe)
                }
            }"
>
    <template x-if="current">
        <div>
            <pd-pipe></pd-pipe>
        </div>
    </template>
</div>
</template>
<template x-component="pd-pipe" c-data="{ initialInput: {} }">
    <div x-data="pipeActions" class="d-flex flex-column gap-4">
        <div class="d-flex gap-3">
            <h1>Pipe: <span x-text="current?.name"></span></h1>
            <div class="btn-group">
                <button class="btn btn-primary" type="button" @click="() => pipeForm('open')">Edit</button>
                <button class="btn btn-primary" type="button" @click="() => { deletePipe(); this.$router.push('/') }">
                    Delete
                </button>
                <button class="btn btn-primary" type="button" @click="() => $refs.dependencyform.showModal()">Add Dependency</button>
            </div>
        </div>
        <div class="form-check form-switch" :class="{'text-primary': current.execOnServer}">
            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault"
                   :checked="current.execOnServer" @click="() => {
                        current.execOnServer = !current.execOnServer
                        $store.pipes.save(current)
                    }">
            <label class="form-check-label"
                   for="flexSwitchCheckDefault">Execute on backend</label>
            <i x-transition x-show="current.execOnServer" class="bi bi-cloud-arrow-up"></i>
        </div>
        <pd-pipe-output></pd-pipe-output>
        <p x-text="current.description"></p>
        <dialog x-ref="pipeform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="() => { savePipe(); pipeForm('close') }">
                <label for="pipename" class="form-label"> Name </label>
                <input class="form-control" type="text" id="pipename" x-model="current.name">
                <label for="pipedescription" class="form-label"> Description </label>
                <input type="text" id="pipedescription" x-model="current.description" class="form-control">
                <div>
                    <label for="pipedefaultinput" class="form-label"> Default Input </label>
                    <input class="form-control" type="text" id="pipedefaultinput"
                           x-text="$el.value = $tojson($store.pipes.current.defaultInput || {})"
                           @input="(event) => {
                        try {
                            $store.pipes.current.defaultInput = JSON.parse(event.target.value)
                            event.target.classList.add('is-valid')
                            event.target.classList.remove('is-invalid')
                        } catch (e) {
                            console.error(e)
                            event.target.classList.add('is-invalid')
                        }
                    }">
                </div>
                <button class="btn btn-primary">Save</button>
            </form>
            <json-viewer :data="$tojson(current)"></json-viewer>
        </dialog>
        <dialog x-ref="dependencyform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="async (e) => {
                const data = Object.fromEntries(new FormData(e.target).entries())
                const newFunction = await $store.functions.newDependencyFunction(data)
                $store.pipes.addFunctionToCurrentPipe(newFunction.id, { start: true })
            }">
                <label for="path" class="form-label"> Path </label>
                <input name="path" class="form-control" type="text" id="path">
                <label for="export" class="form-label"> Export </label>
                <input name="export" type="text" id="export" class="form-control">
                <label for="alias" class="form-label"> Alias </label>
                <input name="alias" type="text" id="alias" class="form-control">
                <label for="deptype" class="form-label"> Type </label>
                <select required name="deptype" type="text" id="deptype" class="form-control">
                    <option value="javascript">.js</option>
                    <option value="css">.css</option>
                    <option value="deno">Deno</option>
                    <!--                    <option value="npm">NPM</option>-->
                </select>
                <button class="btn btn-primary">Save</button>
            </form>
            <json-viewer :data="$tojson(current)"></json-viewer>
        </dialog>

        <div class="border">
            <label for="pipeinitialinput" class="form-label"> Pipe Input </label>
            <input class="form-control" type="text" id="pipeinitialinput"
                   x-text="$el.value = $tojson($store.pdPipe.initialInput)"
                   @input="(event) => {
                        try {
                            $store.pdPipe.initialInput = JSON.parse(event.target.value)
                            event.target.classList.add('is-valid')
                            event.target.classList.remove('is-invalid')
                        } catch (e) {
                            console.error(e)
                            event.target.classList.add('is-invalid')
                        }
                    }">
            <pd-pipe-input-selector
                @selected="e => { $store.pdPipe.initialInput = $fromjson(e.detail) }"
            ></pd-pipe-input-selector>
        </div>
    </div>
    <div class="pdtoolbar sticky-top" x-html="() => {
        return PD.pdPipeToolbar()
          .then(outputs => {
            return outputs.html
          })
    }"></div>
    <template x-if="$store.functions.loaded">
        <pd-pipe-functions>
        </pd-pipe-functions>
    </template>
</template>
<template x-component="pd-pipe-output">
    <div class="d-flex flex-column gap-3"
         x-data="{
            init(){
                window.addEventListener('message', (e) => {
                  const data = JSON.parse(e.data)
                  this.output = data;
                  if(data.server) e.source.close();
                })
            },
            output: {},
        }">
        <h3>Pipe Input</h3>
        <json-viewer :data="$tojson($store.pdPipe.initialInput)"></json-viewer>

        <div :style="output.error && { backgroundColor: 'red'}">
            <h3>Pipe Output</h3>
            <json-viewer :data="$tojson(output)"></json-viewer>
            <template x-if="output.error">
                <json-viewer :data="$tojson(output.error)"></json-viewer>
            </template>
        </div>
    </div>
</template>

<template x-component="pd-pipe-functions">
    <div class="d-flex flex-column gap-1 py-4" x-data="{
        removeFunction(id){
            $store.pipes.removeFunctionFromCurrentPipe(id);
        },
    }">
        <h3>Functions</h3>
        <template x-for="(F, index) in current.functions" :key="F">
            <div x-data="{
                        get func (){
                            return $store.functions.getFunction(F);
                        },
                        showInput: false,
                        showCode: true,
                        showOutput: true
                    }">
                <template x-if="func && func.id">
                    <div class="d-flex">
                        <div class="w-100">
                            <pd-function
                                    :tab="(func.transform && func.transform.prop && 'transform') || (func.pipeid && 'pipe') || 'code'"></pd-function>
                            <json-viewer
                                    :data="await $store.api.getFuncOutput(func.id).then(data => $tojson(data))"></json-viewer>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </div>
</template>

<template x-component="pd-pipe-input-selector">
    <div x-data="{
            async pipeInputs(){
                return await PD.pdGetPipeInputs({ server: true, pipe: $store.pipes.current }).then(outputs => {
                    return outputs.pipeInputs
                })
            }
        }">
        <select
                class="overflow-hidden"
                @input.stop="() => $dispatch('selected', $el.value)">
            <option> --- Test with an input ---</option>
            <template x-for="(input, index) in pipeInputs">
                <option x-text="$tojson(input)"></option>
            </template>
        </select>
    </div>
    <template x-component="pd-function-form"></template>
</template>
<template x-component="pd-pipe-selector">
    <div x-data="pipeActions">
        <div class="list-group">
            <template x-for="pipe in pipes()">
                <button class="list-group-item list-group-item-action" @click="() => {
                        $dispatch('pipe-selected', pipe.id)
                        $store.pdPipeSelector.selected = pipe.id
                    }">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold" x-text="pipe.name"></div>
                        <span x-text="pipe.description"></span>
                    </div>
                </button>
            </template>
        </div>
    </div>
</template>

