<div x-data="pipeActions"
     x-init="() => {
                const pipe = pipes().find(p => p.id === Number($router.params.pipeid))
                if (pipe) {
                    load(pipe)
                }
            }"
>
    <template x-if="current">
        <div>
            <pd-pipe></pd-pipe>
            <pd-process-current></pd-process-current>
        </div>
    </template>
</div>
</template>
<template x-component="pd-pipe" c-data="{ initialInput: {} }">
    <div x-data="pipeActions" class="d-flex flex-column gap-4">
        <div class="d-flex gap-3">
            <h1>Pipe: <span x-text="current?.name"></span></h1>
            <div class="btn-group">
                <button class="btn btn-primary" type="button" @click="() => pipeForm('open')">Edit</button>
                <button class="btn btn-primary" type="button" @click="() => { deletePipe(); this.$router.push('/') }">
                    Delete
                </button>
                <button class="btn btn-primary" type="button" @click="() => $refs.dependencyform.showModal()">Add
                    Dependency
                </button>
            </div>
        </div>
        <div class="form-check form-switch" :class="{'text-primary': current.execOnServer}">
            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault"
                   x-model="current.execOnServer">
            <label class="form-check-label"
                   for="flexSwitchCheckDefault">Execute on backend</label>
            <i x-transition x-show="current.execOnServer" class="bi bi-cloud-arrow-up"></i>
        </div>
        <p x-text="current.description"></p>
        <dialog x-ref="pipeform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="() => { savePipe(); pipeForm('close') }">
                <label for="pipename" class="form-label"> Name </label>
                <input class="form-control" type="text" id="pipename" x-model="current.name">
                <label for="pipedescription" class="form-label"> Description </label>
                <input type="text" id="pipedescription" x-model="current.description" class="form-control">
                <button class="btn btn-primary">Save</button>
            </form>
            <json-viewer :data="$tojson(current)"></json-viewer>
        </dialog>
        <dialog x-ref="dependencyform" class="w-75 h-75">
            <h4>Pipe Form</h4>
            <form class="d-flex flex-column gap-4" @submit.prevent="(e) => {
                const data = Object.fromEntries(new FormData(e.target).entries())
                const newFunction = $store.functions.newDependencyFunction(data)
                $store.pipes.addFunctionToCurrentPipe(newFunction.id, { start: true })
            }">
                <label for="path" class="form-label"> Path </label>
                <input name="path" class="form-control" type="text" id="path">
                <label for="export" class="form-label"> Export </label>
                <input name="export" type="text" id="export" class="form-control">
                <label for="alias" class="form-label"> Alias </label>
                <input name="alias" type="text" id="alias" class="form-control">
                <label for="deptype" class="form-label"> Type </label>
                <select required name="deptype" type="text" id="deptype" class="form-control">
                    <option value="javascript">.js</option>
                    <option value="css">.css</option>
                    <option value="deno">Deno</option>
                    <!--                    <option value="npm">NPM</option>-->
                </select>
                <button class="btn btn-primary">Save</button>
            </form>
            <json-viewer :data="$tojson(current)"></json-viewer>
        </dialog>

        <div class="border">
            <label for="pipeinitialinput" class="form-label"> Pipe Input </label>
            <input class="form-control" type="text" id="pipeinitialinput"
                   x-text="$el.value = $tojson($store.pdPipe.initialInput)"
                   @input="(event) => {
                        try {
                            $store.pdPipe.initialInput = JSON.parse(event.target.value)
                            event.target.classList.add('is-valid')
                            event.target.classList.remove('is-invalid')
                        } catch (e) {
                            console.error(e)
                            event.target.classList.add('is-invalid')
                        }
                    }">
            <pd-pipe-input-selector
                    @selected="e => { $store.pdPipe.initialInput = current.inputs[e.detail] }"></pd-pipe-input-selector>
        </div>
    </div>

    <template x-if="$store.functions.loaded">
        <pd-pipe-functions>
        </pd-pipe-functions>
    </template>
</template>
<template x-component="pd-process-current">
    <div class="d-flex flex-column gap-3" x-data="{
        init(){
            window.addEventListener('message', (e) => {
              const data = JSON.parse(e.data)
              this.output = data;
            })
        },
        output: '',
    }">
        <button class="btn btn-lg btn-success w-100"
                @click.prevent="async () => {
            output = await $store.pipes.process(current, $store.pdPipe.initialInput)
        }">Process
        </button>
        <h3>Pipe Input</h3>
        <json-viewer :data="$tojson($store.pdPipe.initialInput)"></json-viewer>
        <h3>Pipe Output</h3>
        <json-viewer :data="$tojson(output)"></json-viewer>
    </div>
</template>

<template x-component="pd-pipe-functions">
    <div class="d-flex flex-column gap-1 py-4" x-data="{
        addFunction(after){
            const newFunction = $store.functions.newFunction()
            $store.pipes.addFunctionToCurrentPipe(newFunction.id, { after })
        },
        addRenderFunction(after){
            const newFunction = $store.functions.newRenderFunction()
            $store.pipes.addFunctionToCurrentPipe(newFunction.id, { after })
        },
        addTransformFunction(after){
            const newFunction = $store.functions.newTransformFunction()
            $store.pipes.addFunctionToCurrentPipe(newFunction.id, { after })
        },
        addPipeFunction(after){
            $refs.pipeselectordialog.showModal()
            const listener = document.addEventListener('pipe-selected', (e) => {
                PD[e.detail]({json: true}).then(pipe => {
                    const newFunction = $store.functions.newPipeFunction({ pipe })
                    $store.pipes.addFunctionToCurrentPipe(newFunction.id, { after })
                })
                document.removeEventListener('pipe-selected', listener)
            })
        },
        removeFunction(id){
            $store.pipes.removeFunctionFromCurrentPipe(id);
        },
        getFunction(id){
            return $store.pipes.getFunctions().find(F => F.id === id)
        },
        getFunctions(){
            return this.current.functions.map(F => this.getFunction(F)).filter(F => F) || []
        },
        addExistingFunction(){
            $router.push('/functions/add-to-current-pipe')
        },
        sortDialog(){
            $refs.sortdialog.showModal()
        },
    }">
        <h3>Functions</h3>
        <template x-for="(F, index) in current.functions" :key="F">
            <div x-data="{
                        init(){
                            this.func = $store.functions.getFunction(F);
                        },
                        func: {},
                        showInput: false,
                        showCode: true,
                        showOutput: true,
                        getFirstInput(F){
                            return this.func.inputs.slice(-1)[0];
                        },
                        getFirstOutput(F){
                            return this.func.outputs.slice(-1)[0];
                        },
                        insertFunctionAfter(func){
                            $refs.insertfuncdialog.showModal()
                        },
                    }">
                <template x-if="func && !func.render">
                    <div class="d-flex">
                        <div class="d-flex flex-column">
                            <button class="btn" x-text="func.id">

                            </button>
                            <button @click="sortDialog" class="btn btn-info">
                                <i class="bi bi-arrow-down-up"></i>
                            </button>
                            <button @click="insertFunctionAfter(func)" class="btn btn-success">
                                <i class="bi bi-plus"></i>
                            </button>
                            <button @click="() => {
                                const funcPosition = current.functions.findIndex(f => f === func.id)
                                const untilThisFunc = current.functions.slice(0, funcPosition+1)
                                $store.pipes.process({name: 'temp'}, { temp: true, funcs: untilThisFunc })
                            }" class="btn btn-success mt-5">
                                <i class="bi bi-play"></i>
                            </button>
                        </div>
                        <div class="w-100">
                            <pd-function
                                    :tab="(func.transform && func.transform.prop && 'transform') || (func.pipeid && 'pipe') || 'code'"></pd-function>
                            <json-viewer :data="$tojson(getFirstOutput(), { pretty: true })"></json-viewer>
                        </div>
                    </div>
                </template>
                <template x-if="func && func.render">
                    <div class="d-flex ignore-elements">
                        <div class="d-flex flex-column">
                            <button class="btn">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button @click="insertFunctionAfter(func)" class="btn btn-success">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="w-100">
                            <pd-function :tab="'render'"></pd-function>
                        </div>
                    </div>
                </template>
                <dialog x-ref="insertfuncdialog">
                    <div class="btn-group-vertical justify-content-center gap-2">
                        <button class="btn btn-success" @click="addTransformFunction(index)">Transform</button>
                        <button class="btn btn-success" @click="addRenderFunction(index)">Render / Preview</button>
                        <button class="btn btn-primary" @click="addFunction(index)">New Function</button>
                        <button class="btn btn-primary" @click="addExistingFunction">Existing Function</button>
                        <button class="btn btn-secondary" @click="addPipeFunction(index)">Inline Pipe</button>
                    </div>
                </dialog>
            </div>
        </template>
        <dialog x-ref="sortdialog">
            <div
                    x-intersect:enter="initSortable"
                    x-data="{
                    initSortable(){
                        const sort = Sortable.create($el, {
                            items: '.item',
                            handle: '.handle',
                            ghostClass: 'placeholder',
                            onEnd: (_evt) => {
                                $store.pipes.reorderFunctions(sort.toArray());
                            }
                        })
                    }
                }"
                    class="btn-group-vertical justify-content-center gap-2">
                <template x-for="F in current.functions">
                    <button
                            :data-id="F"
                            x-data="{ func: null, init(){ this.func = $store.functions.getFunction(F); } }"
                            class="item handle btn btn-primary d-flex gap-3">
                        <i class="bi bi-arrows-move"></i>
                        <span x-text="func.id"></span>
                        <span class="ms-auto" x-text="func.name"> </span>
                    </button>
                </template>
            </div>
        </dialog>
        <dialog x-ref="pipeselectordialog">
            <pd-pipe-selector></pd-pipe-selector>
        </dialog>
    </div>
</template>

<template x-component="pd-pipe-input-selector">
    <div x-data="{
            get pipeInputs(){
                return Array.from(new Set(this.current.inputs)).map($tojson)
            }
        }">
        <select
                class="overflow-hidden"
                @input.stop="() => $dispatch('selected', $el.value)">
            <option> --- Test with an input ---</option>
            <template x-for="(input, index) in pipeInputs">
                <option x-text="input" :value="index"></option>
            </template>
        </select>
    </div>
    <template x-component="pd-function-form"></template>
</template>
<template x-component="pd-pipe-selector">
    <div x-data="pipeActions">
        <div class="list-group">
            <template x-for="pipe in pipes()">
                <button class="list-group-item list-group-item-action" @click="() => {
                        $dispatch('pipe-selected', pipe.id)
                        $store.pdPipeSelector.selected = pipe.id
                    }">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold" x-text="pipe.name"></div>
                        <span x-text="pipe.description"></span>
                    </div>
                </button>
            </template>
        </div>
    </div>
</template>

