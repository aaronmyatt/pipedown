<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/svg+xml" href="/vite.svg"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vite App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!--    <link rel="stylesheet" href="/styles/style.scss"/>-->
    <!--    <script type="application/javascript" src="https://unpkg.com/prettier@3.0.0/standalone.js"></script>-->
    <!--    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/prettier@3.0.0/plugins/babel.js"></script>-->
    <!--    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/prettier@3.0.0/plugins/estree.js"></script>-->
    <!--    import prism script and css-->
    <!--    <script src="/prism.js"></script>-->
    <!--    <link rel="stylesheet" href="/prism.css"/>-->
</head>
<body class="container-md">
<div x-data="{
    burnToast(toast, timeout = 5000) {
        setTimeout(() => {
            $store.toaster = $store.toaster.filter(t => t.message !== toast.message)
        }, timeout)
    }
}" class="toast-container top-0 end-0">
    <template x-for="toast in $store.toaster">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                <strong class="me-auto">Hol' up!</strong>
                <small class="text-body-secondary">just now</small>
                <button
                        @click="() => burnToast(toast, 0)"
                        type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close">
                </button>
            </div>
            <div class="toast-body">
                <p x-text="toast.message"></p>
                <div class="mt-2 pt-2 border-top">
                    <template x-for="action in toast.actions">
                        <button class="btn btn-primary" @click="() => action.callback(); burnToast(toast)"
                                x-text="action.label"></button>
                    </template>
                </div>
            </div>
        </div>
    </template>
</div>
<nav class="navbar" x-data>
    <div class="d-flex align-items-center gap-4">
        <div class="nav-item">
            <a class="nav-link" href x-route="/">
                <h3 class="mx-auto">
                    Pipe <i class="bi bi-arrow-down"></i>
                </h3>
            </a>
        </div>

        <div class="nav-item" x-show="$store.pipes.current?.id">
            <a class="nav-link" href x-route="`/pipe/${$store.pipes.current}`">Pipe</a>
        </div>

        <div class="nav-item">
            <a class="nav-link" href x-route="/functions">Functions</a>
        </div>
    </div>
</nav>
<main>
</main>
<footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
    <h3 class="mx-auto">
        Pipe <i class="bi bi-arrow-down"></i>
    </h3>
</footer>

<div x-data>
    <template x-view="/">

        <!--        <div x-data="{-->
        <!--            code: 'function wat(watwat){ console.log(watwat) }'-->
        <!--        }">-->
        <!--            <pre-->
        <!--                    @input="code = $el.textContent"-->
        <!--                    contenteditable=""-->
        <!--                    class="language-javascript" x-init="async () => {-->
        <!--            code = $el.textContent-->
        <!--            $el.textContent = await prettier.format($el.textContent, { parser: 'babel', plugins: prettierPlugins })-->
        <!--            Prism.highlightElement($el)-->
        <!--        }">-->
        <!--        </pre>-->
        <!--        <pre x-text="code"></pre>-->
        <!--        </div>-->

        <div x-html="async () => {
            return await PD.pdPipeList({server: true}).then(output => output.html);
        }"></div>
        <div x-html="async () => {
            return fetch('http://localhost:8000/api/process/10/html')
                .then(response => response.text())
        }"></div>
        <pd-pipes-list></pd-pipes-list>
        <template x-component="pd-pipes-list">
            <div x-data="pipeActions">
                <ul class="list-group">
                    <template x-for="pipe in pipes()">
                        <li class="list-group-item list-group-item-action"
                            @click="() => $router.push('/pipe/' + pipe.id)">
                            <a href="#" class="d-flex justify-content-between align-items-start ">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold" x-text="pipe.name"></div>
                                    <span x-text="pipe.description"></span>
                                </div>
                                <button class="btn btn-primary" @click="deletePipe(pipe)">Remove</button>
                            </a>
                        </li>
                    </template>
                </ul>
                <button @click="newPipe()">New Pipe</button>
            </div>
        </template>
    </template>
    <template x-view="/pipe/pipeid"></template>
    <template x-view="/functions">
        <pd-function-list></pd-function-list>
    </template>
    <template x-view="/functions/add-to-current-pipe">
        <pd-function-list addtocurrent="1"></pd-function-list>
    </template>
    <template x-component="pd-function-list" c-data="{
            addtocurrent: false,
        }">
        <div>
            <ul
                    class="list-group"
                    x-data="{
                    query: '',
            functions(){
                return $store.functions.allFunctions
                    .filter(func => !func.archived)
                    .filter(func => {
                        return func.name.toLowerCase().includes(this.query.toLowerCase()) || func.description.toLowerCase().includes(this.query.toLowerCase())
                    })
            }
        }">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Search" aria-label="Search"
                           aria-describedby="button-addon2" x-model="query">
                </div>
                <template x-for="func in functions()" :key="func.id">
                    <li class="list-group-item list-group-item-action"
                        x-data="{
                    output: null,
                    testInput: null,
                }">
                        <div class="d-flex">
                            <p class="flex-shrink-1" x-text="func.id"></p>
                            <pd-function tab="detail"></pd-function>
                        </div>
                        <template x-if="addtocurrent">
                            <button class="btn btn-primary" @click.prevent="() => {
                                PD.pdBrowserActions({action: 'ADD_EXISTING_FUNCTION', pipe: $store.pipes.current, func })
                                    .then(async output => {
                                        await $store.pipes.fetch()
                                    })
                            }"> Add to current pipe </button>
                        </template>
                    </li>
                </template>
            </ul>
        </div>
    </template>


    <template x-component="pd-function" c-data="{
        tab: '',
        render: '',
        propertyeditor: '',
        pipefunc: '',
    }">
        <div tabindex="1"
             x-data="{
            editFunction(content) {
                $refs.functionform.showModal()
            },
            deleteFunction(func, archive = false){
                try{
                    $store.pipes.removeFunctionFromCurrentPipe(func.id);
                }catch(e){
                    console.warn(func.name + ' is not in current pipe')
                }
                if(archive)
                    $store.functions.delete(func)
                $refs.deletefunctiondialog.close()
            },
            processFunction(func){
                $store.pipes.process({name: 'temp'}, { temp: true, funcs: [func.id] })
            },
            editCode() {
                $refs.functioncodeeditor.showModal()
            },
            testFunction() {
                $refs.functiontestdialog.showModal()
            },
            active: null,
            testInput: {},
            testOutput: null,
            changeTab(tab) {
                this.tab = null;
                this.active = tab
            },
        }">
            <ul class="nav nav-tabs" style="--bs-nav-link-padding-y: 0px;">
                <li class="nav-item" @click="changeTab('detail')">
                    <button :class="(active || tab) === 'detail' && 'active'" class="nav-link">Detail</button>
                </li>
                <li class="nav-item" @click="changeTab('code')">
                    <button :class="(active || tab) === 'code' && 'active'" class="nav-link">Code</button>
                </li>
                <li class="nav-item" @click="changeTab('raw')">
                    <button :class="(active || tab) === 'raw' && 'active'" class="nav-link">Raw</button>
                </li>
                <li x-show="func && func.render" class="nav-item" @click="changeTab('render')">
                    <button :class="(active || tab) === 'render' && 'active'" class="nav-link">Render</button>
                </li>
                <li class="nav-item" @click="changeTab('transform')">
                    <button :class="(active || tab) === 'transform' && 'active'" class="nav-link">Transform</button>
                </li>
                <li class="nav-item" @click="changeTab('pipe')">
                    <button :class="(active || tab) === 'pipe' && 'active'" class="nav-link">Pipe</button>
                </li>
            </ul>
            <div class="border rounded">
                <div x-show="(active || tab) === 'detail'">
                    <div class="d-flex gap-3">
                        <h4><span x-text="func.name"></span></h4>
                        <div class="btn-group">
                            <button class="btn btn-primary" type="button" @click="editFunction(func)">Edit</button>
                            <button class="btn btn-primary" type="button" @click="() => {
                                $refs.deletefunctiondialog.showModal()
                            }">Delete
                            </button>
                            <button
                                    class="btn btn-primary" type="button" @click="testFunction">Test
                            </button>
                        </div>
                    </div>
                    <p x-text="func !== undefined && func.description"></p>
                </div>
                <div x-show="(active  || tab) === 'code'">
                    <pd-function-code-editor></pd-function-code-editor>
                </div>
                <div x-show="(active  || tab) === 'raw'">
                    <json-viewer :data="$tojson(func)"></json-viewer>
                </div>
                <template x-if="(active  || tab) === 'render'">
                    <div>
                        <pd-render-function></pd-render-function>
                    </div>
                </template>
                <template x-if="(active  || tab) === 'transform'">
                    <div x-data="{
                        funcProp: func.transform && func.transform.prop,
                    }">
                        <div class="input-group">
                            <select class="form-control">
                                <option value="property">Edit One Property</option>
                                <option value="jmespath">jmespath</option>
                            </select>
                            <!--                            <pd-function-input-property-selector-->
                            <!--                                    x-init="$nextTick(() => { $el.selected = funcProp })"-->
                            <!--                                    @selected="(e) => {-->
                            <!--                                        func.transform = func.transform || { prop: '' }-->
                            <!--                                        funcProp = e.detail-->
                            <!--                                        func.transform.prop = funcProp-->
                            <!--                                        $store.functions.save(func)-->
                            <!--                            }"></pd-function-input-property-selector>-->
                            <input type="text" x-model="funcProp" :value="func.transform && func.transform.prop">
                            <button
                                    @click="() => {
                                        func.transform = func.transform || { prop: '' }
                                        func.transform.prop = funcProp
                                        $store.functions.save(func)
                                    }"
                                    x-show="funcProp !== func.transform.prop">
                                Save Change
                            </button>
                        </div>
                        <template x-if="funcProp">
                            <pd-function-property-editor
                                    @code-change="(e) => {
                                        func.code = `// this input was generated by the property editor
// making changes manually may have unexpected results
input.${funcProp} = \`${e.detail}\``
                                        console.log(func.code)
                                        $store.functions.save(func)
                                    }"
                                    :prop="() => funcProp"></pd-function-property-editor>
                        </template>
                    </div>
                </template>
                <template x-if="(active || tab) === 'pipe'">
                    <h4><span x-text="func.name"></span></h4>
                </template>
            </div>

            <dialog x-ref="functioncodeeditor" class="w-75 h-75">
                <pd-function-code-editor></pd-function-code-editor>
            </dialog>
            <dialog x-ref="functionform" class="w-75 h-75">
                <pd-function-form></pd-function-form>
            </dialog>
            <dialog x-ref="functiontestdialog">
                <pd-function-input-selector @selected="e => testInput = e.detail"></pd-function-input-selector>
                <button class="btn btn-primary w-100" @click="processFunction(func)">Process</button>
                <div x-show="testOutput">
                    <h5>Test Output</h5>
                    <json-viewer :data="$tojson(testOutput, { pretty: true })"></json-viewer>
                </div>
            </dialog>
            <dialog x-ref="deletefunctiondialog">
                <div class="btn-group">
                    <button class="btn btn-danger" @click="deleteFunction(func)">Delete From Pipe</button>
                    <button class="btn btn-danger" @click="deleteFunction(func, true)">Delete From Everywhere</button>
                </div>
            </dialog>
        </div>
    </template>

    <template x-component="pd-function-code-editor">
        <div
                class="w-100"
                style="min-height: 200px;"
                x-data="{
            init(){
                const code = !this.blank && func.code || ''
                editor = CodeMirror({el: $el, code: code, onChange: (change) => {
                    func.code = change
                    func.transform = func.transform || {}
                    func.transform.prop = null
                    $store.functions.save(func)
                }})
            }
        }">
        </div>
    </template>

    <template x-component="pd-function-property-editor">
        <div
                class="w-100"
                style="min-height: 200px;"
                x-data="{
                    init(){
                        this.$watch('funcProp', () => this.initEditor())
                        this.initEditor()
                    },
                    initEditor(){
                        $el.innerHTML = ''
                        CodeMirror({el: $el, code: this.takePropValue(), onChange: (e) => {
                            $dispatch('code-change', e)
                        }})
                    },
                    takePropValue(){
                        const valueIndex = func.code.indexOf('=')
                        const codeValue = func.code.substring(valueIndex + 1).trim()
                        return window.chopQuotes(codeValue)
                    },
                }">
        </div>
    </template>

    <template x-component="pd-render-function">
        <div
                x-init="() => {
                renderPreview()
            }"
                x-data="{
                async renderPreview(input){
                    PD.pdCoreRenderHtmlPreview()
                        .then(pipe => pipe.process())
                        .then((output) => {
                             $refs.putIframe.innerHTML = output.iframe
                             $refs.putIframe.firstChild.addEventListener('load', (e) => {
                                const target = e.target;
                                target.contentWindow.postMessage(JSON.stringify({pipe: current.name}), '*')
                             })
                        })
                        .catch((e) => {
                            console.warn(e)
                        })

                }
            }"
        >
            <div class="w-100" x-ref="putIframe"></div>
        </div>
    </template>

    <template x-component="pd-function-input-selector">
        <div x-data="{
                funcInputs: [],
                init(){
                    this.funcInputs = Array.from(new Set(this.func.inputs))
                }
            }">
            <select
                    class="form-control"
                    @input.stop="() => $dispatch('selected', funcInputs[$el.value])">
                <option> --- Test with an input ---</option>
                <template x-for="(input, index) in funcInputs">
                    <option x-text="$tojson(input, { pretty: true })" :value="index"></option>
                </template>
            </select>
        </div>
    </template>

    <template x-component="pd-function-input-property-selector" c-data="{
        selected: null,
    }">
        <div x-data="{
                keySet: new Set(),
                uniqueFuncPropertyKeys: [],
                init(){
                    this.func.inputs.map((input) => {
                        Object.keys(input).map((key) => {
                            this.keySet.add(key)
                        })
                    })
                    this.uniqueFuncPropertyKeys = Array.from(this.keySet)
                }
            }">
            <select
                    class="form-control">
                @input.stop="() => $dispatch('selected', uniqueFuncPropertyKeys[$el.value] || $el.value)">
                <option> --- Select a property ---</option>
                <template x-for="(key, index) in uniqueFuncPropertyKeys">
                    <option :selected="key === selected" x-text="key" :value="index"></option>
                </template>
            </select>
        </div>
    </template>
    <template x-component="pd-function-form"></template>
</div>
<script src="/scripts/pdglobal.client.js"></script>
<script src="/scripts/pipes-3.json.js"></script>
<script src="/scripts/pipes-1.json.js"></script>
<script>
    pipe1.pipe().process({action: 'NULL'})
</script>
<script type="module" src="/scripts/main.js"></script>
</body>
</html>
